language: ruby

branches:
  only:
    - master

sudo: required

addons:
  apt:
    sources:
      - chef-current-trusty
    packages:
      - chefdk

services:
  - docker

env:
  - SUITE=unit
  - SUITE=sensu-latest
  - SUITE=sensu-029

script:
  - if test "$SUITE" = "unit"; then bundle exec rake; fi
  - if test "$SUITE" != "unit"; then chef exec kitchen test $SUITE; fi

stages:
  - name: test
  - name: deploy
    if: NOT type = cron AND branch = master

jobs:
  include:
    - stage: deploy
      install: skip
      env:
        - VERSION=`ruby -e 'print Gem::Specification.load("sensu-plugins-habitat.gemspec").version'`
      script: skip
      before_deploy:
        - openssl aes-256-cbc -K $encrypted_d1fb8dc1f270_key -iv $encrypted_d1fb8dc1f270_iv -in .travis/id_rsa.enc -out ~/.ssh/id_rsa -d
        - chmod 0600 ~/.ssh/id_rsa
        - git remote set-url origin git@github.com:socrata-platform/sensu-plugins-habitat
        - git tag -a v${VERSION} -m "Tagging v${VERSION} for release"
        - git push --tags
      deploy:
        provider: rubygems
        api_key:
          secure: F0+VKSbFkSa3/Qgbfn3ueaTRQDH5mEjkcXYl9vI6nSbUIJoozNHfwXjDbG9u4GSgmGOygC93YO6v5L6NUuM7Ngd4IfCycpConS8YMIM2xCO+QpeQq2HRlBbfgcnLd8JOf8GgiC1tmTP75vlai5i16SgE6Fki0Tea4JF4T7JmNPQObB5U0F9orB+bil6l2FTdJvgB420shP7kM89Sywe7gaUE6+EPTqEZOtURSZVcy14VDgG2ZqcNDjhWpangrQGjzucqP4yjsZ8uDY56XrSFXYdizDIBOG+/BIK8o3H4FIk2Z0Cu3s+cT/ub4ZIuC/IIA/OM/ONsn/WZVWq5O5kuxSNiRb5hLo9N8+nHlIYcapB31V1jQeFFWjiG0b8Sz1nKiRsO7tZ+SfNdGFOc6cJzDEI2qkCbKGVzFLvjqLlq1GcZwZnXfMbgKYNr9M/6UwsBEKTuvRc6SvJnptrHcy9U+U5PZhY8Fyd2fxqhW5UJO2t/6Bvc3CArnKp+xrnfUjh22fDgXx2gwLbLIgbNSFQAZ2+Zi2JBuP8XorIGBP947sDAf4B7pGTN22aE/aRTAZPs0ylsNW3bNN2O3v0Kw+FJhYzlryO25jqrP+v0ynEYMBM1FPXnFHKPovZVVSjx5sKh/pyAw3F1AtaTi6DIOX/W0dMytSrYUh5WQD0WHfXBKPE=

notifications:
  slack:
    on_failure: change
    on_success: never
    on_pull_requests: false
    rooms:
      - secure: gjKlBOtM95I9Je3qOV416BNL+XL64A0JUYh4CqZqlXgiUxAEt9HLwxAVajBy1DaT8fK15nfcJsvolOrfTQyUzdlStLUuTdcOS32KxFSdLCsCgcmxwriiDI3P2nnSJ3Td2gS2d1hfRKd+5KvPOAlIADkUqqGep3W/pcNKQTYOYbz4LGVtEfrs7vgNGeP68KDb9KYccEGJNAXxNt4ZKdy+pgPlBEkWVi0lQj2f69pgEP0yHlzpEVhu5ahY75eYoVCdy9RPPg+ijt3f2n/1x8TFjq4gsIJwCWXd5eNN+dzJXnQ+2QQCLjTNORYSHPZg1heU5l9KtQebYDZ46XtcrgUbczjbNRQFZMx/774DN1tMOi+LvPdXLLJ0M1Vu703NnLlrAUAtJoJC8zDrfd5mC1ioIRfMAhristwjDMG4yJur4SQ9+mAbUhob6gDb8qFBxkF/HzQjKa8SzoLQmIKvrA61gW/4QN3rvJRXzIsWeYlwTpWP7LPCuOL9jjJKD0JH5Aap/OARot4CJ1A3K8lW55WpA1oodMuQ6ZaJze5XmDcnu/4XUMBn7FWvRii0BdtBS47oREqt7pAP5GxI8Gf6ez/1GAzQSZXOs8SgonOCYshImGFBHnw5QGrgmLCBHSo76SE+/hwQmJQ7wBCSXBIg3kKtiLu/Nn41saXChUBZzqhY8ZA=
